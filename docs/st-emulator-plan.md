# ST エミュレーター実装計画

## 1. 目的と対象範囲
- IEC 61131-3 Structured Text (ST) を厳密に解釈し、既存のラダー実行系と同等のスキャン周期で評価する。
- 既存の `EmulatorController` に統合し、ラダーと ST の状態共有を維持する。
- 仕様準拠: IEC 61131-3 Ed.3 (Part 3) をベースに、以下の構文と振る舞いをカバーする。
  - プログラム宣言、VAR/VAR_TEMP などの宣言ブロック
  - 制御構文: `IF … THEN … ELSIF … ELSE … END_IF`, `CASE`, `FOR`, `WHILE`, `REPEAT`
  - ループからの `EXIT`, `RETURN`
  - ユーザー定義ファンクション/ファンクションブロック呼び出し（初期段階はビルトイン疑似ファンクションのみ）
  - 標準データ型（BOOL, INT, DINT, REAL, STRING 等）と暗黙/明示キャスト
  - 比較・論理・算術演算、ビット演算

## 2. リファレンスと調査要点
- 公式規格概要で ST の構文要素とコントロールフローの定義を再確認。
- 既存のオープンソース ST パーサ（例: PLCopen XML 解析器、ANTLR grammar）を比較し、再利用可否を評価。
- TypeScript / JavaScript 上で LL(k) または LR パーサを構築する場合のライブラリ（`nearley`, `chevrotain`, `antlr4ts` など）と生成ベース（ANTLR grammar → TypeScript ターゲット）を比較。
- 実行モデル: ST は命令列を順次実行し、IEC 準拠のデータ型変換・スコープルールが必要。

## 3. 実装アーキテクチャ案
1. **パーサ層**
   - ANTLR4 版 IEC 61131-3 ST 文法の TypeScript ターゲット生成を検討。
   - 代替案として `chevrotain` で文法を記述し、AST を構築するハンドクラフトパーサを用意。
   - AST ノード定義を `src/runtime/st/ast.ts` に追加。
2. **型システム / シンボルテーブル**
   - 宣言ブロックのスキャン時にスコープを構築 (`PROGRAM`, `VAR`, `VAR_TEMP`, `VAR_INPUT` etc)。
   - 型情報を `src/runtime/st/types.ts` に集約し、基本型とサブレンジの表現を定義。
3. **実行エンジン**
   - AST を `src/runtime/st/interpreter.ts` で評価。
   - スキャン毎に `PROGRAM` エントリの `VAR` 初期化を行い、ルーチン本文を逐次実行。
   - IO との連携は既存 `variables` マップと `IOSimService` を介し、BOOL 出力を即時反映。
4. **エラーハンドリング**
   - 解析時に構文／型エラーを集約し VS Code 診断へ反映。
   - 実行時例外（ゼロ除算等）はサイクルログへ書き出し、該当 POU の実行をスキップ。
5. **ファンクション／FB サポート**
   - 第1フェーズ: 組込み関数（`ABS`, `LIMIT`, `MOD`, `AND`, `OR` 等）をネイティブ実装。
   - 第2フェーズ: ユーザー定義 `FUNCTION`, `FUNCTION_BLOCK` 呼び出しに対応し、状態保持を実装。

## 4. 移行ステップ
1. AST とインタプリタの基礎を構築し、`Counter := Counter + 1;` の既存ケースをパス。
2. 制御構文 (`IF`, `CASE`, `FOR`, `WHILE`, `REPEAT`) を段階的に導入し、各構文に対するユニットテストを作成。
3. 型システムとキャストルールを精緻化。BOOL ↔ INT 等の暗黙変換を IEC 仕様に合わせる。
4. エラー報告と VS Code 診断連携を追加。
5. パフォーマンス測定とプロファイルに基づき最適化。

## 5. テスト戦略
- ユニットテスト: 構文別の AST、インタプリタの評価結果、型エラーの検出を `vitest` で追加。
- 結合テスト: サンプル PLCopen プロジェクトを読み込み、既存ラダーとの混在シナリオを検証。
- 負荷テスト: 大規模 ST プログラムを想定したベンチマーク（1000 行規模）でスキャン時間を計測。

## 6. チェックリスト
- [ ] IEC 61131-3 ST 文法リファレンスの最新版をレビューし、仕様差分を整理する。
- [x] パーサ生成方式（ANTLR vs 手書き）を決定し、PoC を完了する。（Chevrotain ベースで実装）
- [x] AST ノード構造と型システム API を `src/runtime/st/` 配下に追加する。
- [x] 宣言ブロックの解析とシンボルテーブル構築を実装する。
- [x] 制御構文 `IF/ELSIF/ELSE`, `CASE`, `FOR`, `WHILE`, `REPEAT` の評価ロジックを実装しテストする。
- [x] 組込み関数の最小セットを定義し、テストを追加する。（ABS, MIN, MAX, LIMIT）
- [ ] 実行エラー・型エラーを VS Code 診断として表示する機構を追加する。
- [x] 既存 `EmulatorController` との統合を完了し、レグレッションテストを通す。
- [ ] サンプル PLCopen プロジェクトでのエンドツーエンド検証を実施する。
